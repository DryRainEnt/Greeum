# Greeum v4.0 - 웹 서버 아키텍처 비전 문서

**문서 버전**: 1.0
**작성일**: 2025-12-31
**목표**: Greeum을 원격 서버 기반 메모리 시스템으로 전환

---

## 1. 프로젝트 목적

### 1.1 핵심 가치
Greeum은 **LLM을 위한 범용 외부 기억 모듈**이다. 사람의 기억처럼 맥락을 기반으로 관련 정보를 저장하고 검색하여, LLM이 장기적인 맥락을 유지할 수 있도록 돕는다.

### 1.2 v4.0 전환 목표
- **로컬 전용 → 원격 서버 기반**: 여러 클라이언트에서 동일한 기억에 접근
- **MCP 전용 → API 우선**: HTTP REST API를 1차 인터페이스로, MCP는 래퍼로 제공
- **단일 사용자 → 다중 세션 지원**: 추후 멀티유저 확장 가능한 구조

### 1.3 첫 번째 사용자
- **서버**: 현재 로컬 머신 (dryrain PC)
- **클라이언트**: Claude Code (MCP), 향후 다른 LLM 서비스

### 1.4 오픈소스 전략: Open Core

| 오픈소스 (MIT 유지) | 유료/비공개 (향후) |
|--------------------|-------------------|
| `greeum/core/` - 메모리 엔진 | 클라우드 호스팅 서비스 |
| `greeum/server/` - 로컬 API 서버 | 관리 대시보드 |
| `greeum/client/` - Python 클라이언트 | 멀티테넌트 지원 |
| `greeum/mcp/` - MCP 래퍼 | SLA 기술지원 |
| 셀프호스팅 전체 기능 | 엔터프라이즈 기능 |

**수익화 경로**: 셀프호스팅은 무료, 관리형 클라우드 서비스는 유료

---

## 2. 최종 목표 아키텍처

### 2.1 시스템 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                        클라이언트 영역                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Claude Code │  │  다른 LLM   │  │  개발자 앱  │             │
│  │   (MCP)     │  │  서비스     │  │  (직접API)  │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         │                │                │                     │
│  ┌──────┴──────┐        │                │                     │
│  │ MCP 래퍼    │        │                │                     │
│  │ (선택적)    │        │                │                     │
│  └──────┬──────┘        │                │                     │
│         │                │                │                     │
│  ┌──────┴────────────────┴────────────────┴──────┐             │
│  │              단기 기억 캐시 (STM)              │             │
│  │  • 3개 슬롯 (A, B, C)                         │             │
│  │  • 슬롯당 최대 30개 블록 좌표                  │             │
│  │  • 요약 프롬프트 (10회 갱신마다 재작성)        │             │
│  │  ※ 로컬 저장 (세션별)                         │             │
│  └──────────────────────┬────────────────────────┘             │
│                         │                                       │
└─────────────────────────┼───────────────────────────────────────┘
                          │ HTTP REST API
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        서버 영역                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Greeum API Server                       │   │
│  │                  (FastAPI + Uvicorn)                     │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │   /memory   │  │  /search    │  │   /stats    │     │   │
│  │  │   • add     │  │  • query    │  │   • usage   │     │   │
│  │  │   • get     │  │  • similar  │  │   • health  │     │   │
│  │  │   • update  │  │  • branch   │  │   • doctor  │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  │                                                         │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│  ┌──────────────────────┴──────────────────────────────────┐   │
│  │                    Core Engine                           │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              BlockManager (LTM)                  │    │   │
│  │  │  • 브랜치 기반 기억 블록 관리                    │    │   │
│  │  │  • DFS 탐색, 유사도 검색                        │    │   │
│  │  │  • 중복 감지, 품질 검증                         │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │           Embedding Engine                       │    │   │
│  │  │  • sentence-transformers (로컬)                  │    │   │
│  │  │  • 다국어 지원 (한국어, 영어)                    │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └──────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│  ┌──────────────────────┴──────────────────────────────────┐   │
│  │                    Storage Layer                         │   │
│  │  • SQLite (현재) → PostgreSQL (확장 시)                 │   │
│  │  • 벡터 인덱스 (FAISS 또는 내장)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 핵심 설계 원칙

#### 2.2.0 핵심 흐름: 조회 후 저장 (CRITICAL)

> **"신규 기억의 저장에 대해서는 기억 조회 이후 찾아진 최종 블록 위치에서 새로 노드를 연장시켜 저장한다."** - 사업화 문서

```
[신규 기억]
    │
    ▼
[1. 유사 기억 조회] ──────────────────────────────┐
    │  • 기존 메모리에서 유사한 블록들 검색         │
    │  • 각 브랜치별 유사도 점수 계산               │
    ▼                                              │
[2. LLM: 최적 브랜치/블록 결정] ◀─────────────────┘
    │  • 유사 블록들을 컨텍스트로 제공
    │  • "이 새 기억은 어느 맥락에 속하는가?"
    │  • "어느 블록 다음에 연결되어야 하는가?"
    ▼
[3. 위치 결정 및 저장]
    │  • 결정된 블록의 after로 연결
    │  • 또는 시점에 따라 끼워넣기
    ▼
[4. 앵커 갱신]
    • 저장된 블록을 해당 슬롯의 새 앵커로 설정
```

**핵심**: 단순 분류(A/B/C)가 아니라, **기존 메모리를 조회하여 LLM이 맥락을 파악**한 후 저장 위치를 결정한다.

#### 2.2.1 브랜치 기반 기억 관리
- 동일 맥락의 기억은 **동일 브랜치**로 묶어 관리
- 각 브랜치의 **최근 조회 블록을 앵커**로 설정
- 신규 기억은 **조회 결과에 기반하여** 앵커 위치에서 노드를 연장하여 저장

#### 2.2.2 탐색 전략 (조회)
- **맥락 우선 탐색**: 쿼리와 가장 유사한 브랜치를 먼저 선정
- **LLM 기반 브랜치 선정**: 유사 블록들을 LLM에 제공하여 최적 브랜치 결정
- **브랜치 내 유사도 검색**: 선정된 브랜치에서 가장 유사한 블록 탐색
- **탐색 심도 조절**: 인자로 전달하거나 기본값 사용
- **순환 참조 방지**: 이전탐색/이후탐색 분리 후 결과 통합

#### 2.2.3 시점 기반 저장
- 이전 블록 / 다음 블록 구분 (정보가 가리키는 시점 기준)
- 과거 시점 기억: 정확한 위치에 끼워넣기
- 객관적 지식: 동종 지식을 찾아 최신으로 갱신

#### 2.2.4 LLM 활용 방법

| 기능 | LLM 역할 | 입력 | 출력 |
|-----|---------|-----|-----|
| **브랜치 선정** | 유사 블록들의 맥락 비교 | 새 기억 + 각 브랜치 유사 블록 3개 | 최적 브랜치 ID |
| **저장 위치 결정** | 시점/맥락 기반 위치 판단 | 새 기억 + 주변 블록들 | before 블록 ID |
| **동종 지식 판별** | 갱신 vs 신규 저장 판단 | 새 기억 + 유사 기존 기억 | 갱신/신규 여부 |

**LLM 프롬프트 예시 (브랜치 선정)**:
```
기존 메모리에서 찾은 유사한 블록들:
- [브랜치 A] "테스트 서버 배포 완료" (유사도: 0.82)
- [브랜치 A] "API 엔드포인트 수정" (유사도: 0.78)
- [브랜치 C] "테스트 주도 개발 학습" (유사도: 0.71)

새로 저장할 기억: "테스트 코드 작성 완료"

이 기억은 어느 브랜치에 저장되어야 하는가? (A/B/C)
이유와 함께 답하시오.
```

#### 2.2.5 단기 기억 캐시 (STM) - 클라이언트 측
- **3개 슬롯** (A, B, C) - 설정 가능
- 슬롯당 **최대 30개 블록 좌표** (O(1) 접근)
- 각 슬롯에 **요약 프롬프트** 작성
- **10회 캐시/갱신마다** 요약 프롬프트 재작성

---

## 3. 사용자 경험 (UX) 정의

### 3.1 Claude Code 사용자 경험

#### 현재 (v3.x MCP)
```
[Claude Code] ←stdio→ [Greeum MCP Server] ←→ [로컬 SQLite]
```
- 장점: 설정 간단, 즉시 사용
- 단점: 단일 세션, 로컬 제한

#### 목표 (v4.0)
```
[Claude Code] ←stdio→ [MCP 래퍼] ←HTTP→ [Greeum API Server]
                              ↑
                    [로컬 STM 캐시]
```
- 장점: 여러 세션에서 동일 기억 접근, 서버 분리 가능
- 사용자 체감: **기존과 동일** (MCP 인터페이스 유지)

### 3.2 API 직접 사용자 경험

```python
from greeum_client import GreeumClient

# 클라이언트 초기화 (서버 주소 지정)
client = GreeumClient("http://localhost:8400")

# 기억 추가
result = client.add_memory(
    content="프로젝트 X의 아키텍처를 마이크로서비스로 결정",
    importance=0.8
)

# 기억 검색
memories = client.search("프로젝트 X 아키텍처", limit=5)

# STM 캐시 확인 (로컬)
stm_summary = client.get_stm_summary(slot="A")
```

### 3.3 경험 품질 기준

> "모든 구현 및 수정사항의 평가는 사용자의 경험을 기준으로 진행하며, 경험이 개선되는 방향이 아니라면 작업을 재검토한다."

| 측정 항목 | 현재 (v3.x) | 목표 (v4.0) |
|----------|------------|------------|
| 기억 추가 응답 | < 500ms | < 500ms (유지) |
| 기억 검색 응답 | < 200ms | < 300ms (네트워크 포함) |
| 서버 시작 시간 | N/A (MCP) | < 3초 |
| 중복 감지 정확도 | 95%+ | 95%+ (유지) |
| MCP 호환성 | 100% | 100% (유지) |

---

## 4. API 설계

### 4.1 엔드포인트 구조

```
GET  /                          # 서버 정보
GET  /health                    # 헬스체크

# 기억 관리
POST /memory                    # 기억 추가
GET  /memory/{block_id}         # 기억 조회
PUT  /memory/{block_id}         # 기억 수정 (메타데이터)
DELETE /memory/{block_id}       # 기억 삭제 (soft delete)

# 검색
POST /search                    # 기억 검색
POST /search/similar            # 유사 기억 검색
GET  /search/branch/{branch_id} # 브랜치 내 검색

# 통계 및 관리
GET  /stats                     # 기본 통계
GET  /stats/usage               # 사용 분석
POST /admin/doctor              # 시스템 진단
POST /admin/backup              # 백업 생성
```

### 4.2 요청/응답 예시

#### 기억 추가
```http
POST /memory
Content-Type: application/json

{
  "content": "Greeum v4.0 아키텍처 설계 완료",
  "importance": 0.8,
  "tags": ["greeum", "설계", "v4"]
}
```

```json
{
  "success": true,
  "block_index": 153,
  "branch_id": "tech_decisions",
  "storage": "LTM",
  "quality_score": 0.85,
  "duplicate_check": "passed"
}
```

#### 기억 검색
```http
POST /search
Content-Type: application/json

{
  "query": "Greeum 아키텍처",
  "limit": 5,
  "depth": 3
}
```

```json
{
  "results": [
    {
      "block_index": 153,
      "content": "Greeum v4.0 아키텍처 설계 완료",
      "timestamp": "2025-12-31T10:30:00",
      "similarity": 0.92,
      "branch_id": "tech_decisions"
    }
  ],
  "search_stats": {
    "branches_searched": 2,
    "blocks_scanned": 47,
    "elapsed_ms": 45
  }
}
```

---

## 5. 컴포넌트 상세

### 5.1 서버 컴포넌트

```
greeum/
├── server/                    # 신규: API 서버
│   ├── __init__.py
│   ├── app.py                 # FastAPI 앱 (api/anchors_router 포함)
│   ├── config.py              # 서버 설정
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── memory.py          # /memory 엔드포인트
│   │   ├── search.py          # /search 엔드포인트
│   │   └── admin.py           # /admin, /stats 엔드포인트
│   ├── middleware/
│   │   ├── __init__.py
│   │   ├── logging.py         # 요청 로깅
│   │   └── error_handler.py   # 에러 처리
│   └── schemas/
│       ├── __init__.py
│       ├── memory.py          # Pydantic 모델
│       └── search.py
├── api/                       # 기존 유지 (하위호환)
│   ├── anchors.py             # /v1/anchors 라우터 → server/app.py에서 import
│   └── write.py               # AnchorBasedWriter 클래스
├── core/                      # 기존 유지
│   └── ...
├── mcp/                       # 기존 유지 + API 래퍼 추가
│   └── ...
└── client/                    # 신규: Python 클라이언트
    ├── __init__.py
    ├── client.py              # GreeumClient
    └── stm_cache.py           # 로컬 STM 캐시
```

**API 경로 구조**:
- `/memory`, `/search`, `/stats` - 신규 (버전 없음)
- `/v1/anchors` - 기존 유지 (하위호환)

### 5.2 클라이언트 컴포넌트 (MCP 래퍼)

```
greeum/
└── mcp/
    ├── api_wrapper.py         # 신규: API 호출 래퍼
    ├── server_core.py         # 수정: API 래퍼 사용
    └── stm_local.py           # 신규: 로컬 STM 관리
```

### 5.3 데이터 흐름

```
[사용자 입력: "프로젝트 결정사항 저장해줘"]
         │
         ▼
[MCP 래퍼: add_memory 도구 호출]
         │
         ▼
[로컬 STM 캐시 확인] ─────────────────┐
         │                            │
         ▼                            │
[HTTP POST /memory] ──────────────────┼──▶ [API 서버]
         │                            │         │
         │                            │         ▼
         │                            │   [BlockManager]
         │                            │         │
         │                            │         ▼
         │                            │   [SQLite/DB]
         │                            │         │
         ◀────────────────────────────┼─────────┘
         │                            │
         ▼                            │
[STM 캐시 갱신] ◀─────────────────────┘
         │
         ▼
[사용자 응답: "기억이 저장되었습니다 (Block #153)"]
```

---

## 6. 마이그레이션 전략

### 6.1 단계별 전환

#### Phase 1: API 서버 추가 (v4.0-alpha)
- FastAPI 서버 구현
- 기존 core 모듈 그대로 사용
- MCP 서버 병행 운영

#### Phase 2: MCP 래퍼 전환 (v4.0-beta)
- MCP가 API 서버를 호출하도록 변경
- 로컬 STM 캐시 구현
- 기존 MCP 사용자 호환성 유지

#### Phase 3: 안정화 (v4.0)
- 성능 최적화
- 문서화
- 클라이언트 라이브러리 배포

### 6.2 하위 호환성

| 기능 | v3.x | v4.0 |
|-----|------|------|
| MCP 도구 이름 | add_memory, search_memory 등 | **동일** |
| 데이터 형식 | SQLite | **동일** (마이그레이션 불필요) |
| 설정 파일 | ~/.config/greeum | **동일** |

---

## 7. 향후 확장

### 7.1 단기 (v4.x)
- [ ] 인증/인가 (API 키 기반)
- [ ] 다중 사용자 지원 (세션 분리)
- [ ] 웹 대시보드 (통계 시각화)

### 7.2 중기 (v5.x)
- [ ] PostgreSQL 지원 (대용량)
- [ ] 원격 서버 배포 (클라우드)
- [ ] 실시간 동기화 (WebSocket)

### 7.3 장기
- [ ] 팀/조직 단위 기억 공유
- [ ] 기억 권한 관리
- [ ] LLM 서비스 직접 연동 (플러그인)

---

## 8. 성공 기준

### 8.1 기능 완성도
- [ ] 모든 v3.x MCP 기능이 v4.0에서 동작
- [ ] API 서버 단독 실행 가능
- [ ] 클라이언트 라이브러리 제공

### 8.2 성능
- [ ] 기억 추가: < 500ms (99th percentile)
- [ ] 기억 검색: < 300ms (99th percentile)
- [ ] 동시 요청: 10 req/s 이상

### 8.3 안정성
- [ ] 24시간 연속 운영 무중단
- [ ] 데이터 무결성 100%
- [ ] 자동 복구 (crash recovery)

---

**문서 끝**

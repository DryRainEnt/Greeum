# Greeum v3.1.1a1 마이그레이션 및 개선 체크리스트

## 🔴 긴급 수정 사항 (v3.1.0 → v3.1.1a1)

### 1. 임베딩 시스템 전면 교체
- [ ] **문제**: v3.1.0까지 전체 임베딩이 랜덤 해시 기반 (의미 없는 유사도)
- [ ] **해결**: SentenceTransformer 통합 (paraphrase-multilingual-MiniLM-L12-v2)
- [ ] **상태**: SentenceTransformerModel 클래스 구현 완료, 384D→768D 패딩
- [ ] **검증**: 관련 텍스트 유사도 0.5+ 달성 (이전 ~0.007)

### 2. 데이터베이스 불일치 해결
- [ ] **문제**: blocks 테이블 674개 vs block_embeddings 4331개
- [ ] **원인**: 누락된 블록 레코드, 불완전한 마이그레이션
- [ ] **해결**: migrate_embeddings_direct.py 스크립트 작성
- [ ] **남은 작업**: 3653개 'default' 모델 임베딩 마이그레이션

### 3. STM 슬롯 할당 개선
- [ ] **문제**: 모든 메모리가 슬롯 A로만 저장
- [ ] **해결**: 0.4 유사도 임계값 기반 할당 구현
- [ ] **검증**: ABC 패턴 테스트 83.3% 정확도 달성
- [ ] **개선 필요**: STM 앵커 스토어 누락 이슈 수정

## 🟡 상용 배포 준비 사항

### 1. 마이그레이션 자동화
- [ ] **MCP 네이티브 통합**
  - [ ] greeum/mcp/native/tools.py에 migrate_embeddings 함수 추가
  - [ ] 청크 단위 처리 (메모리 안전)
  - [ ] 진행 상태 추적 및 복구 메커니즘

- [ ] **자동 트리거**
  - [ ] BlockManager 초기화 시 구 임베딩 자동 감지
  - [ ] 백그라운드 마이그레이션 실행
  - [ ] 마이그레이션 상태 테이블 추가

- [ ] **안전장치**
  - [ ] 트랜잭션 기반 처리
  - [ ] 실패 시 자동 롤백
  - [ ] 중복 실행 방지 (idempotency)

### 2. 로컬/글로벌 저장소 옵션
- [ ] **CLI 플래그 구현**
  - [ ] `--global` (기본값): ~/.greeum/memory.db
  - [ ] `--local`: ./data/memory.db 또는 지정 경로
  - [ ] `--local /path/to/project`: 특정 경로 지정

- [ ] **MCP 도구 확장**
  - [ ] storage 파라미터 추가 (global/local/경로)
  - [ ] 모든 메모리 함수에 적용

- [ ] **추가 기능**
  - [ ] `--all` 플래그로 로컬+글로벌 동시 검색
  - [ ] .greeum 파일 존재 시 자동 로컬 모드
  - [ ] GREEUM_STORAGE 환경 변수 지원

### 3. 의존성 관리
- [ ] **필수 패키지 체크**
  - [ ] sentence-transformers 설치 여부 확인
  - [ ] 미설치 시 자동 폴백 또는 안내
  - [ ] MCP 환경에서 의존성 보장

## 🟢 테스트 및 검증

### 1. 사용자 요청 테스트 (3가지)
- [ ] **철학 메모리 검색**: "기획 철학은 설계 의도에 반영" 테스트
- [ ] **STM 할당 자유도**: A/B/C 슬롯 동적 할당 테스트
- [ ] **일반 정보 검색**: "공식 사이트 외 커뮤니티" 검색 테스트

### 2. 마이그레이션 검증
- [ ] **전체 마이그레이션**: 4331개 임베딩 모두 st_ 모델로 전환
- [ ] **유사도 검증**: 의미적으로 관련된 메모리 간 0.4+ 유사도
- [ ] **성능 측정**: 마이그레이션 전후 검색 품질 비교

### 3. 슬롯 기반 브랜치 분화
- [ ] **독립 브랜치**: 각 슬롯이 독립적 브랜치 형성 확인
- [ ] **글로벌 저장소**: 슬롯 간 전환 및 병합 테스트
- [ ] **지속성**: 재시작 후에도 슬롯 상태 유지 확인

## 📊 진행 상황

### 완료된 작업
- ✅ SentenceTransformerModel 클래스 구현
- ✅ 384D → 768D 패딩 로직
- ✅ migrate_embeddings.py 스크립트 (부분적)
- ✅ migrate_embeddings_direct.py 스크립트
- ✅ ABC 슬롯 할당 로직 (83.3% 정확도)

### 진행 중
- 🔄 마이그레이션 스크립트 상용화
- 🔄 로컬/글로벌 저장소 설계

### 대기 중
- ⏸️ MCP 네이티브 마이그레이션 함수
- ⏸️ STM 앵커 스토어 이슈 수정
- ⏸️ 3가지 사용자 테스트 실행

## 🚨 주의사항

1. **v3.1.0 시리즈 폐기**: 랜덤 임베딩으로 인한 치명적 결함
2. **마이그레이션 필수**: 기존 사용자 데이터 의미 복구 필요
3. **배포 전 필수 테스트**: 4331개 블록 전체 마이그레이션 완료 확인

## 다음 단계 우선순위

1. **즉시**: 마이그레이션 완료 (3653개 남은 블록)
2. **긴급**: MCP 네이티브 마이그레이션 함수 구현
3. **중요**: 로컬/글로벌 저장소 옵션 구현
4. **검증**: 3가지 사용자 테스트 실행 및 결과 확인

---

*Last Updated: 2025-09-16*
*Version Target: v3.1.1a1*
*Critical Issue: Semantic Embedding Migration*

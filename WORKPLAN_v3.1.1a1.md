# Greeum v3.1.1a1 작업 계획 및 진행 현황

## 📋 Executive Summary

**목표**: 의미 기반 임베딩 시스템 구현으로 진정한 컨텍스트 인식 메모리 시스템 완성

**배경**: v3.1.0 시리즈에서 발견된 치명적 결함
- 모든 임베딩이 해시 기반 랜덤 벡터로 생성됨
- 유사도 계산이 무의미 (모든 값이 ~0)
- 슬롯 선택 로직이 설계 의도와 다르게 동작

---

## 🔴 v3.1.0 시리즈 사후 분석

### 발견된 문제들

| 문제 | 상태 | 영향도 | 해결 방안 |
|------|------|--------|-----------|
| SyntaxError in database_manager.py | ✅ 수정됨 | 🔴 Critical | try-except 블록 들여쓰기 수정 |
| STMManager 인스턴스 불일치 | ✅ 수정됨 | 🔴 Critical | 공유 인스턴스 아키텍처로 변경 |
| branch_meta NOT NULL 제약 | ✅ 수정됨 | 🟡 Major | created_at 필드 처리 추가 |
| 트랜잭션 중첩 오류 | ✅ 수정됨 | 🟡 Major | in_transaction 체크 추가 |
| **임베딩이 전부 랜덤** | ❌ 미해결 | 🔴 **FATAL** | sentence-transformers 필수 |

### 테스트 결과 요약
```
테스트 시나리오: 프로그래밍/철학/요리 컨텍스트 분류
- 기대: 유사 컨텍스트끼리 같은 슬롯 할당
- 실제: 모든 유사도 < 0.05, 무작위 할당

유사도 측정 예시:
- Python-Django: 0.009 (기대: >0.4)
- Python-김치찌개: -0.002 (기대: <0.2)
- Django-김치찌개: 0.001 (기대: <0.2)
```

---

## 🎯 v3.1.1a1 목표 및 작업 계획

### Phase 1: 임베딩 시스템 재구축 (우선순위: 최상)

- [ ] **1.1 Sentence-Transformers 통합**
  - [ ] 의존성 설정 업데이트 (pyproject.toml)
  - [ ] 기본 모델 선정 (multilingual 지원 필수)
  - [ ] EmbeddingModel 구현체 작성
  - [ ] 레지스트리 자동 등록

- [ ] **1.2 Fallback 전략 개선**
  - [ ] sentence-transformers 없을 때 명확한 경고
  - [ ] OpenAI embeddings API 대체 옵션
  - [ ] 최소한 TF-IDF 기반 유사도라도 제공

- [ ] **1.3 임베딩 차원 통일**
  - [ ] 기존 DB 마이그레이션 스크립트
  - [ ] 768D → 384D 변환 옵션 (성능 고려)
  - [ ] 차원 불일치 자동 감지

### Phase 2: 슬롯 할당 로직 검증

- [ ] **2.1 유사도 임계값 튜닝**
  - [ ] 0.4 임계값 재검토
  - [ ] 언어별 임계값 차별화
  - [ ] 동적 임계값 조정 로직

- [ ] **2.2 슬롯 선택 알고리즘**
  - [ ] DFS 검색 대신 직접 유사도 계산 유지
  - [ ] 다중 헤드 비교 (최근 3개 블록)
  - [ ] 가중 평균 유사도 계산

- [ ] **2.3 글로벌 재할당 전략**
  - [ ] 최소 활성 슬롯 선택 로직
  - [ ] 시간 기반 decay 적용
  - [ ] 접근 빈도 고려

### Phase 3: 통합 테스트

- [ ] **3.1 단위 테스트**
  - [ ] 임베딩 품질 검증
  - [ ] 유사도 계산 정확도
  - [ ] 슬롯 할당 일관성

- [ ] **3.2 시나리오 테스트**
  - [ ] 다국어 컨텍스트 처리
  - [ ] 장기 메모리 진화
  - [ ] 브랜치 병합 시나리오

- [ ] **3.3 성능 벤치마크**
  - [ ] 임베딩 생성 속도
  - [ ] 검색 응답 시간
  - [ ] 메모리 사용량

---

## 📊 진행 상황 추적

### 현재 상태 (2024-12-16)
```yaml
버전: 3.1.1a1.dev1
단계: Phase 1 준비
진행률: 5%
차단 요소:
  - sentence-transformers 미설치
  - 테스트 환경 미구축
```

### 주요 마일스톤
| 날짜 | 마일스톤 | 상태 |
|------|---------|------|
| 2024-12-16 | v3.1.0 실패 확인 | ✅ |
| 2024-12-16 | v3.1.1a1 계획 수립 | ✅ |
| TBD | Phase 1 완료 | ⏳ |
| TBD | Phase 2 완료 | ⏳ |
| TBD | v3.1.1a1 출시 | ⏳ |

---

## 🚨 Risk & Mitigation

### 식별된 위험
1. **임베딩 모델 크기**: sentence-transformers 모델이 수백 MB
   - 완화: 경량 모델 옵션 제공

2. **하위 호환성**: 기존 해시 임베딩 DB와 비호환
   - 완화: 마이그레이션 도구 제공

3. **성능 저하**: 실제 임베딩 계산이 해시보다 느림
   - 완화: 캐싱 전략 강화

---

## 📝 작업 로그

### 2024-12-16
- ✅ v3.1.0rc7 SyntaxError 수정
- ✅ STMManager 인스턴스 공유 문제 해결
- ✅ 트랜잭션 관리 개선
- ❌ 임베딩 시스템 전면 실패 발견
- ✅ v3.1.1a1 계획 수립

### Next Steps
1. sentence-transformers 설치 및 테스트
2. 다국어 모델 선정 (한국어 지원 필수)
3. EmbeddingModel 구현체 작성

---

## 📞 Contact & Discussion

- Issue: 임베딩 시스템 관련 논의는 GitHub Issue #xxx
- Branch: feature/v3.1.1a1-semantic-embeddings
- Review: @DryRainEnt

---

*이 문서는 작업 진행에 따라 실시간 업데이트됩니다.*
# FastMCP 시스템 통합 개선 로드맵

## 현재 상태 분석 (2025-09-01)

### 발견된 핵심 문제들
1. **서버 파편화**: 8개 MCP 서버 파일 혼재
2. **AsyncIO 충돌**: 런타임 이벤트 루프 중복 실행
3. **테스트 실패**: 포괄적 검증 20% 통과율
4. **아키텍처 불일치**: 서로 다른 초기화 방식

---

## M2: 통합 MCP 서버 아키텍처 설계

### 목표
단일 통합 서버로 모든 환경(WSL/PowerShell/macOS/Linux)에서 안정적 작동

### 설계 구조
```
greeum/mcp/
├── unified_mcp_server.py          # 단일 진입점
├── adapters/                      # 환경별 어댑터
│   ├── __init__.py
│   ├── fastmcp_adapter.py        # WSL/PowerShell (FastMCP 기반)
│   ├── jsonrpc_adapter.py        # 기존 환경 (JSON-RPC 직접)
│   └── base_adapter.py           # 공통 어댑터 인터페이스
├── core/                         # 핵심 로직
│   ├── __init__.py
│   ├── component_manager.py      # 통합 Greeum 컴포넌트 관리
│   ├── runtime_safety.py        # AsyncIO 안전장치
│   └── compatibility_layer.py   # 기존 API 호환성
└── legacy/                       # 기존 서버들 보관
    ├── claude_code_mcp_server.py
    ├── fastmcp_hotfix_server.py
    └── ...
```

### 핵심 설계 원칙
1. **환경 자동 감지**: 실행 환경에 따라 최적 어댑터 선택
2. **런타임 안전성**: AsyncIO 충돌 완전 방지
3. **API 호환성**: 기존 도구/명령어 100% 보장
4. **확장성**: 새로운 환경/도구 쉽게 추가

---

## M3: 핵심 구현 (예상 3-4일)

### M3.1: 통합 서버 프레임워크 구현
- [ ] unified_mcp_server.py 기본 구조
- [ ] 환경 감지 로직 (WSL/PowerShell/macOS 구분)
- [ ] 어댑터 패턴 구현

### M3.2: 환경별 어댑터 구현  
- [ ] FastMCP 어댑터 (WSL/PowerShell용)
- [ ] JSON-RPC 어댑터 (기존 환경용)
- [ ] 공통 인터페이스 정의

### M3.3: 핵심 안전장치 구현
- [ ] AsyncIO 런타임 충돌 방지
- [ ] 컴포넌트 초기화 통합
- [ ] 에러 복구 메커니즘

### M3.4: 호환성 계층 구현
- [ ] 기존 도구 API 완전 보장
- [ ] CLI 라우팅 업데이트
- [ ] 기존 사용자 워크플로우 보존

---

## M4: 통합 검증 시스템 (예상 2일)

### M4.1: 환경별 테스트
- [ ] macOS 환경 테스트
- [ ] WSL 시뮬레이션 테스트 (가능한 범위)
- [ ] PowerShell 호환성 확인

### M4.2: 기능 통합 테스트
- [ ] 모든 MCP 도구 정상 작동
- [ ] CLI 명령어 완전 호환성
- [ ] 성능 저하 없음 확인

### M4.3: 안정성 검증
- [ ] AsyncIO 충돌 완전 해결
- [ ] 메모리 누수 없음
- [ ] 장시간 실행 안정성

---

## M5: 배포 준비 (예상 1일)

### M5.1: 최종 검증
- [ ] 모든 테스트 100% 통과
- [ ] 문서 업데이트
- [ ] 버전 업데이트 (v2.2.7)

### M5.2: 배포 실행
- [ ] CHANGELOG 업데이트
- [ ] 기존 서버 legacy로 이동
- [ ] 통합 서버로 교체

---

## 성공 기준

### 기술적 성공 기준
- [ ] 모든 환경에서 MCP 서버 정상 시작
- [ ] AsyncIO 충돌 0건
- [ ] 기존 기능 100% 호환
- [ ] 포괄적 테스트 95%+ 통과

### 사용자 경험 기준  
- [ ] `greeum mcp serve` 명령어 정상 작동
- [ ] Claude Code와 완벽한 MCP 연동
- [ ] 기존 워크플로우 변경 없음
- [ ] 에러 메시지 명확하고 도움이 됨

---

## 리스크 및 대응책

### 주요 리스크
1. **호환성 파괴**: 기존 사용자 워크플로우 영향
2. **성능 저하**: 어댑터 패턴으로 인한 오버헤드  
3. **복잡성 증가**: 디버깅 어려움

### 대응책
1. **호환성 테스트**: 각 단계마다 기존 기능 검증
2. **성능 모니터링**: 벤치마크 기준 설정
3. **단순화 우선**: 복잡한 기능은 단계적 추가

---

## 다음 단계

**즉시 시작**: M3.1 통합 서버 프레임워크 구현
**목표 일정**: 7일 내 전체 완성
**검증 기준**: 포괄적 테스트 95%+ 통과
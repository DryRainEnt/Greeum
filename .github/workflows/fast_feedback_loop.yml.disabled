name: Fast Feedback Loop

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ (ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
    inputs:
      test_level:
        description: 'Test Level'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick      # 30ì´ˆ ì´ë‚´
        - standard   # 3ë¶„ ì´ë‚´  
        - full       # 10ë¶„ ì´ë‚´
      debug_mode:
        description: 'Enable Debug Mode'
        required: false
        default: false
        type: boolean

jobs:
  # Phase 1: ì´ˆê³ ì† ê²€ì¦ (30ì´ˆ ì´ë‚´)
  quick-validation:
    runs-on: ubuntu-latest
    name: "âš¡ Quick Validation (30s)"
    timeout-minutes: 2
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # pip ìºì‹œë¡œ ì„¤ì¹˜ ì‹œê°„ ë‹¨ì¶•
        
    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .  # í•„ìˆ˜ ì˜ì¡´ì„± í¬í•¨ ì„¤ì¹˜
        pip install pytest psutil bandit safety
        
    - name: Syntax Check (5ì´ˆ)
      run: |
        python -m py_compile greeum/__init__.py
        python -m py_compile greeum/core/*.py
        python -m py_compile greeum/mcp/*.py
        
    - name: Import Test (5ì´ˆ)
      run: |
        python -c "import greeum; print('âœ… Import OK')"
        python -c "from greeum.core import BlockManager; print('âœ… Core Import OK')"
        python -c "from greeum.mcp import claude_code_mcp_server; print('âœ… MCP Import OK')"
        
    - name: Basic Function Test (10ì´ˆ)
      run: |
        python -c "
        from greeum.text_utils import process_user_input
        result = process_user_input('í…ŒìŠ¤íŠ¸')
        assert 'keywords' in result
        print('âœ… Text Processing OK')
        "
        
    - name: Security Quick Scan (5ì´ˆ)
      run: |
        bandit -r greeum/ -ll --format=custom --msg-template='{relpath}:{line}: {severity}: {msg}' | head -20
        
    - name: Quick Summary
      if: always()
      run: |
        echo "## âš¡ Quick Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "- Syntax Check: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Import Test: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Basic Functions: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Duration:** ~30 seconds" >> $GITHUB_STEP_SUMMARY

  # Phase 2: í‘œì¤€ ê²€ì¦ (3ë¶„ ì´ë‚´) - quick-validation ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
  standard-validation:
    runs-on: ubuntu-latest
    name: "ðŸ” Standard Validation (3m)"
    needs: quick-validation
    if: success()
    timeout-minutes: 4
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install full dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest psutil bandit safety
        
    - name: Core Unit Tests (60ì´ˆ)
      run: |
        python -m pytest tests/test_v204_core.py -v --tb=short --maxfail=3
        
    - name: Integration Tests (60ì´ˆ)
      run: |
        python -m pytest tests/test_v204_integration.py -v --tb=short --maxfail=3
        
    - name: Security Tests (30ì´ˆ)
      run: |
        python -m pytest tests/test_v204_security.py -v --tb=short --maxfail=3
        
    - name: Performance Quick Check (30ì´ˆ)
      run: |
        python -c "
        import time
        from greeum.text_utils import process_user_input
        
        # ì„±ëŠ¥ ê¸°ì¤€ì„  ì²´í¬ (ë¹ ë¥¸ ë²„ì „)
        start = time.time()
        for i in range(50):
            result = process_user_input(f'Performance test {i}')
        duration = time.time() - start
        
        print(f'50 operations in {duration:.2f}s ({duration/50*1000:.1f}ms per operation)')
        
        # ê¸°ì¤€: 50ê°œ ì²˜ë¦¬ê°€ 5ì´ˆ ì´ë‚´
        if duration > 5:
            print('âŒ Performance regression detected!')
            exit(1)
        else:
            print('âœ… Performance OK')
        "
        
    - name: Standard Summary
      if: always()
      run: |
        echo "## ðŸ” Standard Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Tests: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Check: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Duration:** ~3 minutes" >> $GITHUB_STEP_SUMMARY

  # Phase 3: ì‹¬í™” ê²€ì¦ (10ë¶„ ì´ë‚´) - ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ
  deep-validation:
    runs-on: ubuntu-latest
    name: "ðŸ”¬ Deep Validation (10m)"
    needs: standard-validation
    if: |
      success() && (
        github.event_name == 'workflow_dispatch' && 
        github.event.inputs.test_level == 'full'
      ) || (
        github.ref == 'refs/heads/main' && 
        github.event_name == 'push'
      )
    timeout-minutes: 12
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest psutil bandit safety
        
    - name: Mini Stress Test (5ë¶„)
      run: |
        python -c "
        import time
        from greeum.core.database_manager import DatabaseManager
        from greeum.text_utils import process_user_input
        from pathlib import Path
        import tempfile
        import shutil
        
        # ìž„ì‹œ ë°ì´í„°ë² ì´ìŠ¤
        test_dir = Path(tempfile.mkdtemp())
        db = DatabaseManager(str(test_dir / 'stress.db'))
        
        try:
            print('Mini stress test: 1000 operations...')
            start = time.time()
            
            for i in range(1000):
                content = f'Stress test content {i} with some details'
                result = process_user_input(content)
                
                block_data = {
                    'block_index': i,
                    'timestamp': '2025-07-30T12:00:00',
                    'context': content,
                    'keywords': result.get('keywords', []),
                    'tags': result.get('tags', []),
                    'embedding': result.get('embedding', []),
                    'importance': 0.5,
                    'hash': f'stress_{i}',
                    'prev_hash': f'stress_{i-1}' if i > 0 else ''
                }
                db.add_block(block_data)
                
                if i % 200 == 0:
                    print(f'  Progress: {i}/1000')
            
            duration = time.time() - start
            print(f'âœ… 1000 operations completed in {duration:.2f}s')
            
            # ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
            results = db.search_blocks_by_keyword(['stress'], limit=10)
            print(f'âœ… Search returned {len(results)} results')
            
        finally:
            shutil.rmtree(test_dir)
        "
        
    - name: Memory Leak Check (3ë¶„)
      run: |
        python -c "
        import gc
        import psutil
        import time
        from greeum.text_utils import process_user_input
        
        process = psutil.Process()
        
        # ì´ˆê¸° ë©”ëª¨ë¦¬
        gc.collect()
        initial_memory = process.memory_info().rss / 1024 / 1024
        print(f'Initial memory: {initial_memory:.1f}MB')
        
        # ë©”ëª¨ë¦¬ ì§‘ì•½ì  ìž‘ì—…
        for cycle in range(5):
            print(f'Memory cycle {cycle + 1}/5')
            
            for i in range(200):
                content = 'Memory test content ' * 100  # ~2KB per item
                result = process_user_input(content)
                # ê²°ê³¼ë¥¼ ì¦‰ì‹œ ë²„ë¦¼ (ë©”ëª¨ë¦¬ í•´ì œ í…ŒìŠ¤íŠ¸)
                del result, content
            
            gc.collect()
            current_memory = process.memory_info().rss / 1024 / 1024
            print(f'  After cycle {cycle + 1}: {current_memory:.1f}MB')
        
        # ìµœì¢… ë©”ëª¨ë¦¬
        final_memory = process.memory_info().rss / 1024 / 1024
        memory_increase = final_memory - initial_memory
        
        print(f'Final memory: {final_memory:.1f}MB')
        print(f'Memory increase: {memory_increase:.1f}MB')
        
        # ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê¸°ì¤€: 20MB ì´í•˜
        if memory_increase > 20:
            print('âŒ Potential memory leak detected!')
            exit(1)
        else:
            print('âœ… Memory usage OK')
        "
        
    - name: Dependency Security Scan (1ë¶„)
      run: |
        safety check --json --output safety-report.json || true
        python -c "
        import json
        from pathlib import Path
        
        if Path('safety-report.json').exists():
            with open('safety-report.json') as f:
                report = json.load(f)
            
            if 'vulnerabilities' in report and report['vulnerabilities']:
                print(f'âŒ Found {len(report[\"vulnerabilities\"])} vulnerabilities')
                for vuln in report['vulnerabilities'][:3]:  # ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
                    print(f'  - {vuln.get(\"package\", \"Unknown\")}: {vuln.get(\"vulnerability\", \"Unknown\")}')
                exit(1)
            else:
                print('âœ… No security vulnerabilities found')
        else:
            print('âœ… Security scan completed')
        "
        
    - name: Deep Summary
      if: always()
      run: |
        echo "## ðŸ”¬ Deep Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "- Mini Stress Test: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Memory Leak Check: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Scan: ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Duration:** ~10 minutes" >> $GITHUB_STEP_SUMMARY

  # Debug ì •ë³´ ìˆ˜ì§‘ (ì‹¤íŒ¨ ì‹œì—ë§Œ)
  debug-info:
    runs-on: ubuntu-latest
    name: "ðŸ› Debug Info Collection"
    if: |
      always() && (
        needs.quick-validation.result == 'failure' ||
        needs.standard-validation.result == 'failure' ||
        needs.deep-validation.result == 'failure' ||
        github.event.inputs.debug_mode == 'true'
      )
    needs: [quick-validation, standard-validation, deep-validation]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Collect System Info
      run: |
        echo "## ðŸ› Debug Information" >> $GITHUB_STEP_SUMMARY
        echo "### System Information" >> $GITHUB_STEP_SUMMARY
        echo "- OS: $(uname -a)" >> $GITHUB_STEP_SUMMARY
        echo "- Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- Pip: $(pip --version)" >> $GITHUB_STEP_SUMMARY
        echo "### Disk Space" >> $GITHUB_STEP_SUMMARY
        df -h >> $GITHUB_STEP_SUMMARY
        echo "### Memory" >> $GITHUB_STEP_SUMMARY
        free -h >> $GITHUB_STEP_SUMMARY
        
    - name: Check Greeum Installation
      run: |
        python -c "
        try:
            import greeum
            print('âœ… Greeum import successful')
            print(f'Version: {getattr(greeum, \"__version__\", \"Unknown\")}')
            
            from greeum.core import BlockManager, DatabaseManager
            print('âœ… Core modules import successful')
            
            from greeum.mcp import claude_code_mcp_server
            print('âœ… MCP modules import successful')
            
        except Exception as e:
            print(f'âŒ Import failed: {e}')
            import traceback
            traceback.print_exc()
        "
        
    - name: List Installed Packages
      run: |
        echo "### Installed Packages" >> $GITHUB_STEP_SUMMARY
        pip list >> $GITHUB_STEP_SUMMARY

  # ìµœì¢… ìƒíƒœ ë¦¬í¬íŠ¸
  final-report:
    runs-on: ubuntu-latest
    name: "ðŸ“Š Final Report"
    if: always()
    needs: [quick-validation, standard-validation, deep-validation, debug-info]
    
    steps:
    - name: Generate Final Report
      run: |
        echo "# ðŸš€ Greeum CI/CD Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ê° ë‹¨ê³„ ê²°ê³¼
        quick_result="${{ needs.quick-validation.result }}"
        standard_result="${{ needs.standard-validation.result }}"
        deep_result="${{ needs.deep-validation.result }}"
        
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Status | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ Quick Validation | ${quick_result} | ~30s |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Standard Validation | ${standard_result:-skipped} | ~3m |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¬ Deep Validation | ${deep_result:-skipped} | ~10m |" >> $GITHUB_STEP_SUMMARY
        
        # ì „ì²´ ìƒíƒœ ê²°ì •
        if [ "$quick_result" = "success" ] && [ "$standard_result" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Overall Status: PASS" >> $GITHUB_STEP_SUMMARY
          echo "All critical tests passed. Ready for deployment!" >> $GITHUB_STEP_SUMMARY
        elif [ "$quick_result" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ Overall Status: PARTIAL" >> $GITHUB_STEP_SUMMARY
          echo "Basic functionality OK, but some advanced tests failed." >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Overall Status: FAIL" >> $GITHUB_STEP_SUMMARY
          echo "Critical issues detected. Immediate attention required!" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ë‹¤ìŒ ë‹¨ê³„ ê°€ì´ë“œ
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "$quick_result" != "success" ]; then
          echo "1. ðŸš¨ Fix syntax/import errors first" >> $GITHUB_STEP_SUMMARY
          echo "2. Re-run quick validation" >> $GITHUB_STEP_SUMMARY
        elif [ "$standard_result" != "success" ]; then
          echo "1. ðŸ” Check unit/integration test failures" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix failing tests" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-run standard validation" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. âœ… All tests passing!" >> $GITHUB_STEP_SUMMARY
          echo "2. Ready for merge/deployment" >> $GITHUB_STEP_SUMMARY
        fi
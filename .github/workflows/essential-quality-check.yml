name: Essential Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    name: "ğŸ¯ Essential Check (Python ${{ matrix.python-version }})"
    timeout-minutes: 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: 1. Syntax Check
      run: |
        python -m py_compile greeum/__init__.py
        python -m py_compile greeum/client.py
        python -m py_compile greeum/utils.py
        python -m py_compile greeum/core/database_manager.py
        python -m py_compile greeum/core/block_manager.py
        
    - name: 2. Basic Import Test
      run: |
        python -c "import greeum; print('âœ… Basic import OK')"
        python -c "from greeum import BlockManager, DatabaseManager; print('âœ… Core modules OK')"
        python -c "from greeum.client import MemoryClient; print('âœ… Client OK')"
        
    - name: 3. Essential Function Test
      run: |
        python -c "
        import tempfile, os
        from greeum.core.database_manager import DatabaseManager
        from greeum.core.block_manager import BlockManager
        
        # ì„ì‹œ DBë¡œ ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        with tempfile.TemporaryDirectory() as tmpdir:
            db_path = os.path.join(tmpdir, 'test.db')
            
            # ë°ì´í„°ë² ì´ìŠ¤ ë§¤ë‹ˆì € ì´ˆê¸°í™”
            db_manager = DatabaseManager(db_path=db_path)
            block_manager = BlockManager(db_manager)
            
            # ë©”ëª¨ë¦¬ ì¶”ê°€
            result = block_manager.add_memory('í…ŒìŠ¤íŠ¸ ë©”ëª¨ë¦¬', importance=0.8)
            print(f'âœ… Memory add result: {result}')
            
            # ê¸°ë³¸ í†µê³„ í™•ì¸ (ë©”ëª¨ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€)
            try:
                # SQLiteì—ì„œ ì§ì ‘ í™•ì¸
                import sqlite3
                conn = sqlite3.connect(db_path)
                count = conn.execute('SELECT COUNT(*) FROM long_term_memory').fetchone()[0]
                conn.close()
                assert count > 0, 'No memories found in database'
                print(f'âœ… Database has {count} memories')
            except Exception as e:
                print(f'Database check failed: {e}')
                
        print('ğŸ‰ Core functions working!')
        "
        
    - name: 4. Hidden Dependencies Check  
      run: |
        # ìˆ¨ì€ ì˜ì¡´ì„± í™•ì¸ (CI ì‹¤íŒ¨ì˜ ì£¼ì›ì¸)
        python -c "
        try:
            import sqlite3, json, datetime, hashlib, re
            print('âœ… Standard library OK')
            
            import numpy, sqlalchemy, flask, requests
            print('âœ… Major dependencies OK')
            
        except ImportError as e:
            print(f'âŒ Missing dependency: {e}')
            exit(1)
        "